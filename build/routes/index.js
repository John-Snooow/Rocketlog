"use strict";var E=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var Y=(t,e)=>{for(var r in e)E(t,r,{get:e[r],enumerable:!0})},Z=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Q(e))!X.call(t,o)&&o!==r&&E(t,o,{get:()=>e[o],enumerable:!(s=K(e,o))||s.enumerable});return t};var $=t=>Z(E({},"__esModule",{value:!0}),t);var te={};Y(te,{routes:()=>h});module.exports=$(te);var H=require("express");var W=require("express");var i=class{message;statusCode;constructor(e,r=400){this.message=e,this.statusCode=r}};var U=require("@prisma/client"),m=new U.PrismaClient({log:process.env.NODE_ENV==="production"?[]:["query"]});var P=require("bcrypt"),d=require("zod"),y=class{async create(e,r){let s=d.z.object({name:d.z.string().trim().min(2),email:d.z.string().email(),password:d.z.string().min(6)}),{name:o,email:n,password:a}=s.parse(e.body);if(await m.user.findFirst({where:{email:n}}))throw new i("User with same email already exists");let A=await(0,P.hash)(a,8),C=await m.user.create({data:{name:o,email:n,password:A}}),{password:T,...I}=C;return r.status(201).json(I)}};var _=(0,W.Router)(),ee=new y;_.post("/",ee.create);var N=require("express");var c=require("zod"),re=c.z.object({DATABASE_URL:c.z.string().url(),JWT_SECRET:c.z.string(),PORT:c.z.coerce.number().default(3333)}),k=re.parse(process.env);var R={jwt:{secret:k.JWT_SECRET,expiresIn:"1d"}};var F=require("jsonwebtoken"),L=require("bcrypt"),v=require("zod"),g=class{async create(e,r){let s=v.z.object({email:v.z.string().email(),password:v.z.string().min(6)}),{email:o,password:n}=s.parse(e.body),a=await m.user.findFirst({where:{email:o}});if(!a)throw new i("Invalid email or password",401);if(!await(0,L.compare)(n,a.password))throw new i("Invalid email or password",401);let{secret:A,expiresIn:C}=R.jwt,T=(0,F.sign)({role:a.role??"customer"},A,{subject:a.id,expiresIn:C}),{password:I,...G}=a;return r.json({token:T,user:G})}};var z=(0,N.Router)(),se=new g;z.post("/",se.create);var M=require("express");var b=require("zod"),x=class{async create(e,r){let s=b.z.object({user_id:b.z.string().uuid(),description:b.z.string()}),{user_id:o,description:n}=s.parse(e.body);return await m.delivery.create({data:{userId:o,description:n}}),r.status(201).json()}async index(e,r){let s=await m.delivery.findMany({include:{user:{select:{name:!0,email:!0}}}});return r.json(s)}};var l=require("zod"),j=class{async update(e,r){let s=l.z.object({id:l.z.string().uuid()}),o=l.z.object({status:l.z.enum(["processing","shipped","delivered"])}),{id:n}=s.parse(e.params),{status:a}=o.parse(e.body);return await m.delivery.update({data:{status:a},where:{id:n}}),await m.deliveryLog.create({data:{deliveryId:n,description:a}}),r.json()}};var J=require("jsonwebtoken");function f(t,e,r){try{let s=t.headers.authorization;if(!s)throw new i("JWT token not found",401);let[,o]=s.split(" "),{role:n,sub:a}=(0,J.verify)(o,R.jwt.secret);return t.user={id:a,role:n},r()}catch{throw new i("Invalid JWT token",401)}}function w(t){return(e,r,s)=>{if(!e.user)throw new i("Unauthorized",401);if(!t.includes(e.user.role))throw new i("Unauthorized",401);return s()}}var p=(0,M.Router)(),D=new x,oe=new j;p.use(f,w(["sale"]));p.post("/",D.create);p.get("/",D.index);p.patch("/:id/status",oe.update);var O=require("express");var u=require("zod"),q=class{async create(e,r){let s=u.z.object({delivery_id:u.z.string().uuid(),description:u.z.string()}),{delivery_id:o,description:n}=s.parse(e.body),a=await m.delivery.findUnique({where:{id:o}});if(!a)throw new i("delivery not found",404);if(a.status==="delivered")throw new i("this order has already been delivered");if(a.status==="processing")throw new i("change status to shipped");return await m.deliveryLog.create({data:{deliveryId:o,description:n}}),r.status(201).json()}async show(e,r){let s=u.z.object({delivery_id:u.z.string().uuid()}),{delivery_id:o}=s.parse(e.params),n=await m.delivery.findUnique({where:{id:o},include:{user:!0,logs:!0}});if(e.user?.role==="customer"&&e.user.id!==n?.userId)throw new i("the user can only view their deliveries",401);return r.json(n)}};var S=(0,O.Router)(),B=new q;S.post("/",f,w(["sale"]),B.create);S.get("/:delivery_id/show",f,w(["sale","customer"]),B.show);var h=(0,H.Router)();h.use("/users",_);h.use("/sessions",z);h.use("/deliveries",p);h.use("/delivery-logs",S);0&&(module.exports={routes});
//# sourceMappingURL=index.js.map