"use strict";var Y=Object.create;var F=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var se=Object.getPrototypeOf,oe=Object.prototype.hasOwnProperty;var te=(r,e,s,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of re(e))!oe.call(r,t)&&t!==s&&F(r,t,{get:()=>e[t],enumerable:!(o=ee(e,t))||o.enumerable});return r};var ie=(r,e,s)=>(s=r!=null?Y(se(r)):{},te(e||!r||!r.__esModule?F(s,"default",{value:r,enumerable:!0}):s,r));var P=ie(require("express")),rr=require("express-async-errors");var Z=require("express");var k=require("express");var i=class{message;statusCode;constructor(e,s=400){this.message=e,this.statusCode=s}};var N=require("@prisma/client"),m=new N.PrismaClient({log:process.env.NODE_ENV==="production"?[]:["query"]});var W=require("bcrypt"),c=require("zod"),y=class{async create(e,s){let o=c.z.object({name:c.z.string().trim().min(2),email:c.z.string().email(),password:c.z.string().min(6)}),{name:t,email:n,password:a}=o.parse(e.body);if(await m.user.findFirst({where:{email:n}}))throw new i("User with same email already exists");let C=await(0,W.hash)(a,8),_=await m.user.create({data:{name:t,email:n,password:C}}),{password:I,...U}=_;return s.status(201).json(U)}};var z=(0,k.Router)(),ne=new y;z.post("/",ne.create);var O=require("express");var l=require("zod"),ae=l.z.object({DATABASE_URL:l.z.string().url(),JWT_SECRET:l.z.string(),PORT:l.z.coerce.number().default(3333)}),v=ae.parse(process.env);var g={jwt:{secret:v.JWT_SECRET,expiresIn:"1d"}};var L=require("jsonwebtoken"),J=require("bcrypt"),x=require("zod"),b=class{async create(e,s){let o=x.z.object({email:x.z.string().email(),password:x.z.string().min(6)}),{email:t,password:n}=o.parse(e.body),a=await m.user.findFirst({where:{email:t}});if(!a)throw new i("Invalid email or password",401);if(!await(0,J.compare)(n,a.password))throw new i("Invalid email or password",401);let{secret:C,expiresIn:_}=g.jwt,I=(0,L.sign)({role:a.role??"customer"},C,{subject:a.id,expiresIn:_}),{password:U,...X}=a;return s.json({token:I,user:X})}};var T=(0,O.Router)(),me=new b;T.post("/",me.create);var M=require("express");var j=require("zod"),q=class{async create(e,s){let o=j.z.object({user_id:j.z.string().uuid(),description:j.z.string()}),{user_id:t,description:n}=o.parse(e.body);return await m.delivery.create({data:{userId:t,description:n}}),s.status(201).json()}async index(e,s){let o=await m.delivery.findMany({include:{user:{select:{name:!0,email:!0}}}});return s.json(o)}};var f=require("zod"),E=class{async update(e,s){let o=f.z.object({id:f.z.string().uuid()}),t=f.z.object({status:f.z.enum(["processing","shipped","delivered"])}),{id:n}=o.parse(e.params),{status:a}=t.parse(e.body);return await m.delivery.update({data:{status:a},where:{id:n}}),await m.deliveryLog.create({data:{deliveryId:n,description:a}}),s.json()}};var H=require("jsonwebtoken");function w(r,e,s){try{let o=r.headers.authorization;if(!o)throw new i("JWT token not found",401);let[,t]=o.split(" "),{role:n,sub:a}=(0,H.verify)(t,g.jwt.secret);return r.user={id:a,role:n},s()}catch{throw new i("Invalid JWT token",401)}}function h(r){return(e,s,o)=>{if(!e.user)throw new i("Unauthorized",401);if(!r.includes(e.user.role))throw new i("Unauthorized",401);return o()}}var p=(0,M.Router)(),D=new q,pe=new E;p.use(w,h(["sale"]));p.post("/",D.create);p.get("/",D.index);p.patch("/:id/status",pe.update);var B=require("express");var u=require("zod"),S=class{async create(e,s){let o=u.z.object({delivery_id:u.z.string().uuid(),description:u.z.string()}),{delivery_id:t,description:n}=o.parse(e.body),a=await m.delivery.findUnique({where:{id:t}});if(!a)throw new i("delivery not found",404);if(a.status==="delivered")throw new i("this order has already been delivered");if(a.status==="processing")throw new i("change status to shipped");return await m.deliveryLog.create({data:{deliveryId:t,description:n}}),s.status(201).json()}async show(e,s){let o=u.z.object({delivery_id:u.z.string().uuid()}),{delivery_id:t}=o.parse(e.params),n=await m.delivery.findUnique({where:{id:t},include:{user:!0,logs:!0}});if(e.user?.role==="customer"&&e.user.id!==n?.userId)throw new i("the user can only view their deliveries",401);return s.json(n)}};var A=(0,B.Router)(),V=new S;A.post("/",w,h(["sale"]),V.create);A.get("/:delivery_id/show",w,h(["sale","customer"]),V.show);var d=(0,Z.Router)();d.use("/users",z);d.use("/sessions",T);d.use("/deliveries",p);d.use("/delivery-logs",A);var $=require("zod");function G(r,e,s,o){return r instanceof i?s.status(r.statusCode).json({message:r.message}):r instanceof $.ZodError?s.status(400).json({message:"validation error",issues:r.format()}):s.status(500).json({message:r.message})}var R=(0,P.default)();R.use(P.default.json());R.use(d);R.use(G);var K=v.PORT;R.listen(K,()=>console.log(`Server is running on port ${K}`));
//# sourceMappingURL=server.js.map