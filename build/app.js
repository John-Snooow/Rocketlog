"use strict";var $=Object.create;var R=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var se=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty;var oe=(r,e)=>{for(var s in e)R(r,s,{get:e[s],enumerable:!0})},N=(r,e,s,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of re(e))!te.call(r,o)&&o!==s&&R(r,o,{get:()=>e[o],enumerable:!(t=ee(e,o))||t.enumerable});return r};var ie=(r,e,s)=>(s=r!=null?$(se(r)):{},N(e||!r||!r.__esModule?R(s,"default",{value:r,enumerable:!0}):s,r)),ne=r=>N(R({},"__esModule",{value:!0}),r);var de={};oe(de,{app:()=>C});module.exports=ne(de);var I=ie(require("express")),tr=require("express-async-errors");var G=require("express");var k=require("express");var i=class{message;statusCode;constructor(e,s=400){this.message=e,this.statusCode=s}};var P=require("@prisma/client"),m=new P.PrismaClient({log:process.env.NODE_ENV==="production"?[]:["query"]});var W=require("bcrypt"),c=require("zod"),y=class{async create(e,s){let t=c.z.object({name:c.z.string().trim().min(2),email:c.z.string().email(),password:c.z.string().min(6)}),{name:o,email:n,password:a}=t.parse(e.body);if(await m.user.findFirst({where:{email:n}}))throw new i("User with same email already exists");let S=await(0,W.hash)(a,8),_=await m.user.create({data:{name:o,email:n,password:S}}),{password:U,...F}=_;return s.status(201).json(F)}};var z=(0,k.Router)(),ae=new y;z.post("/",ae.create);var M=require("express");var l=require("zod"),me=l.z.object({DATABASE_URL:l.z.string().url(),JWT_SECRET:l.z.string(),PORT:l.z.coerce.number().default(3333)}),L=me.parse(process.env);var v={jwt:{secret:L.JWT_SECRET,expiresIn:"1d"}};var J=require("jsonwebtoken"),H=require("bcrypt"),g=require("zod"),x=class{async create(e,s){let t=g.z.object({email:g.z.string().email(),password:g.z.string().min(6)}),{email:o,password:n}=t.parse(e.body),a=await m.user.findFirst({where:{email:o}});if(!a)throw new i("Invalid email or password",401);if(!await(0,H.compare)(n,a.password))throw new i("Invalid email or password",401);let{secret:S,expiresIn:_}=v.jwt,U=(0,J.sign)({role:a.role??"customer"},S,{subject:a.id,expiresIn:_}),{password:F,...Y}=a;return s.json({token:U,user:Y})}};var T=(0,M.Router)(),pe=new x;T.post("/",pe.create);var O=require("express");var b=require("zod"),j=class{async create(e,s){let t=b.z.object({user_id:b.z.string().uuid(),description:b.z.string()}),{user_id:o,description:n}=t.parse(e.body);return await m.delivery.create({data:{userId:o,description:n}}),s.status(201).json()}async index(e,s){let t=await m.delivery.findMany({include:{user:{select:{name:!0,email:!0}}}});return s.json(t)}};var f=require("zod"),q=class{async update(e,s){let t=f.z.object({id:f.z.string().uuid()}),o=f.z.object({status:f.z.enum(["processing","shipped","delivered"])}),{id:n}=t.parse(e.params),{status:a}=o.parse(e.body);return await m.delivery.update({data:{status:a},where:{id:n}}),await m.deliveryLog.create({data:{deliveryId:n,description:a}}),s.json()}};var D=require("jsonwebtoken");function w(r,e,s){try{let t=r.headers.authorization;if(!t)throw new i("JWT token not found",401);let[,o]=t.split(" "),{role:n,sub:a}=(0,D.verify)(o,v.jwt.secret);return r.user={id:a,role:n},s()}catch{throw new i("Invalid JWT token",401)}}function h(r){return(e,s,t)=>{if(!e.user)throw new i("Unauthorized",401);if(!r.includes(e.user.role))throw new i("Unauthorized",401);return t()}}var p=(0,O.Router)(),B=new j,ue=new q;p.use(w,h(["sale"]));p.post("/",B.create);p.get("/",B.index);p.patch("/:id/status",ue.update);var V=require("express");var u=require("zod"),E=class{async create(e,s){let t=u.z.object({delivery_id:u.z.string().uuid(),description:u.z.string()}),{delivery_id:o,description:n}=t.parse(e.body),a=await m.delivery.findUnique({where:{id:o}});if(!a)throw new i("delivery not found",404);if(a.status==="delivered")throw new i("this order has already been delivered");if(a.status==="processing")throw new i("change status to shipped");return await m.deliveryLog.create({data:{deliveryId:o,description:n}}),s.status(201).json()}async show(e,s){let t=u.z.object({delivery_id:u.z.string().uuid()}),{delivery_id:o}=t.parse(e.params),n=await m.delivery.findUnique({where:{id:o},include:{user:!0,logs:!0}});if(e.user?.role==="customer"&&e.user.id!==n?.userId)throw new i("the user can only view their deliveries",401);return s.json(n)}};var A=(0,V.Router)(),Z=new E;A.post("/",w,h(["sale"]),Z.create);A.get("/:delivery_id/show",w,h(["sale","customer"]),Z.show);var d=(0,G.Router)();d.use("/users",z);d.use("/sessions",T);d.use("/deliveries",p);d.use("/delivery-logs",A);var K=require("zod");function Q(r,e,s,t){return r instanceof i?s.status(r.statusCode).json({message:r.message}):r instanceof K.ZodError?s.status(400).json({message:"validation error",issues:r.format()}):s.status(500).json({message:r.message})}var C=(0,I.default)();C.use(I.default.json());C.use(d);C.use(Q);0&&(module.exports={app});
//# sourceMappingURL=app.js.map